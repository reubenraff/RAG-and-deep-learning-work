
"""
personal project RAG pipeline using a section of the ProfGMarkets podcast, property of ProfG media *I don't own the data*, just enjoy the content, and used it to demonstrate a RAG pipeline
"""

# Make sure the model path is correct for your system!
import langchain_community 
from langchain_community import llms 

#from langchain_community.llms import LlamaCpp
from langchain_community.llms import LlamaCpp
from langchain_huggingface import HuggingFaceEmbeddings
import os

os.environ["PYTORCH_MPS_HIGH_WATERMARK_RATIO"]='0.0'
model_id = "HuggingFaceH4/zephyr-7b-beta"

from langchain_huggingface.llms import HuggingFacePipeline
from transformers import AutoModelForCausalLM, AutoTokenizer, pipeline


tokenizer = AutoTokenizer.from_pretrained(model_id)
model = AutoModelForCausalLM.from_pretrained(model_id)
pipe = pipeline("text-generation", model=model, tokenizer=tokenizer, max_new_tokens=40,device="cpu")
hf = HuggingFacePipeline(pipeline=pipe)

text = """
Today's number 16. Silicon Valley Bank was the 16th largest bank in America and it collapsed within hours.
Oh my God, a special episode, Una episode especial, who is here for you when you need them most, who is always there for you, not me, not me. The truth is I'm not really concerned with the condition of your soul. I will not take care of you when you're older, but I am bored and in a good mood. Chelsea won today. So here we are breaking down a bank's failure at Elsin, Robin to my Batman, Elvis to my Castello, Halloumi to my falafel. Walk us through what happened here, Ed.
Okay, let's get serious for a sec. Here's the breakdown. So Silicon Valley Bank collapsed on Friday and what amounts to the second biggest bank failure in history. Here's how it happened. On Wednesday, SVB, one of the nation's largest startup lenders announced it needed to raise funds and it liquidated $21 billion worth of investments in an emergency sale. The next day, customers, aka startup founders, panicked and attempted to withdraw $42 billion in funds. That's about a quarter of the bank's total deposits. So by the end of Thursday, SVB had a negative cash balance of $1 billion and the stock was down 60%. Trading was halted after shares fell another 60% pre-market on Friday. Then FDIC regulators shut the Silicon Valley Bank down and took possession of the lender and its deposits. And in just two days, the nation's 16th largest bank went from fully functioning to insolvent. So Scott, there are so many questions here. Let's just start with this. Government, should the government step in here? Will the government step in here? And if so, how will they do it?
Well, let's go meta first. Let's talk about what actually happened and what was the cause for this, that you have this, what is the second largest bank failure in history and it kind of, it was the speed of the unraveling that's really dramatic here. And the first thing is, the reason that financial institutions typically go out of business is not because of poor performance or because of fraud, it's because of mismatched durations. Now, what do we mean by that? And that is you invest long and you borrow short. Now what do we mean by that? So Silicon Valley bank takes deposits and those depositors, whether it's a startup or an individual can ask for their money right away and they have to honor that request and give them their money. So to a certain extent, they borrow money short. In this instance, they invested long and that is they bought treasury bills. And my understanding is they were three year dated or three year term treasury bills. So they sort of invested long or there was a mismatch such that when for whatever reason they needed to sell those long-term bonds, they had to take a loss on them because their depositors could demand money back. And what really caused this was not just an increase in interest rates, but the pace of the velocity of an increase in interest rates. Specifically, the federal funds rate has gone from 25 basis points to 475 basis points in 12 months. We haven't seen anything like that since 1979 when Volcker decided he was gonna be the lion tamer with a chair and a whip the size of the Florida peninsula. I'm not wearing out Florida peninsula anyways. And he raised rates dramatically in 1979. So Silicon Valley bank had taken their deposits or a portion of the deposits and had purchased these three year treasury bills, which by the way, isn't that insane? That isn't probably something that a lot of banks haven't done. It's not as if they were buying tokens or investing in other shitty crypto companies or a Ponzi scheme. There was no fraud here. And you would even argue that it wasn't really anything that a lot of banks don't do. But interest rates increased dramatically, meaning that when VC startups that are having a particularly tough time this year needed more capital than SVP had imagined or needed to withdraw more deposits faster than SVP had anticipated, they had to sell these long-term bonds who were now worth a lot less because they were only yielding one and a quarter points. If they'd been able to hold onto them until maturity, they probably would have been okay. But because they were a four seller, which you never want to be, they had to take a big loss on them and which created a liquidity.
Well, sorry, could you explain exactly how that works? Why is it that when interest rates go up, the bonds that they had previously bought are suddenly not worth as much? So a bond at par is a hundred. So you buy a hundred dollars worth of a treasury bill, right, you buy a treasury bill for a hundred dollars, it's yielding 1%. That means you get $1 a year coupon. When all of a sudden the market demands 5%, those bonds in order to give a new purchaser of that bond a yield of 5%, it has to be sold for, I don't know, what is that 95 cents on the dollar? So the value of the underlying bond goes down. Now, if you were willing to just collect 1% and hold it for three years, eventually at maturity, you'd get your hundred dollars back. But along the way, you would be giving up yield because the same bond would be yielding four or 5% in this market. So the value of those bonds goes down. People are withdrawing funds, they need liquidity to meet those withdrawal requests. So they're a forced seller of bonds and they have to sell those bonds at a discount, such that the purchasers of those bonds in the open market gets a yield that reflects today's market. That creates a liquidity crisis. And then the second thing or the final thing that really took this bank down and it's something that I think people didn't anticipate was just how concentrated their customer base is. And it's not even concentrated around a sector. It's concentrated, I think we're gonna find out in the post-mortem here. It was concentrated around 40 or 50 VCs. So I have a good friend who's a VC and on I think Wednesday or Thursday, he called every one of his portfolio companies. They went into a warm room mentality. They called every portfolio company and said, get your money out of SVB right now. And when you're a startup CEO and you have 20 or $30 million at SVB and your VC calls you and says, get the money out, you get the money out. There's very little downside to transferring it out, but there's a lot of downside to ignoring that call from your VC if something happens. So I would speculate here, Ed, that we're gonna find out that 40 or 50, maybe even less VCs really began this run on the bank because between 40 or 50, the top VCs, you're probably talking 1,000 to 3,000 clients with somewhere between 10 and $100 million at this bank, which created, that was basically the starting gun, if you will, of the run on the bank. Yeah, so 50% of VC-backed startups in the US bank with SVB. So this is huge for the tech world. And you're mentioning that the VCs that you know, they told their portcos, pull your funds. And we already know from the reporting that some of the VCs included a Founders Fund, that's Peter Thiel's VC firm, pair VC, Union Square Ventures, Co2, a bunch of them were doing this. But there were also a lot of VCs that said that they were gonna continue banking with SVB. Some of those included General Castlist, Greylock, Coastal Ventures. Do you feel like there was an obligation to stand with SVB during this? And that is, was it sort of a betrayal to SVB who had been banking these guys for the past, at least two decades, to suddenly when things look a little bit scary, to say pull it and essentially cause this run on the bank? Well, you have no friends on Wall Street, isn't that the saying? And I mean, I've been on, I've had so much email traffic because I am conflicted in all over this thing. We have, we're all, Prof G has their account at SVB. Oh, wow. So are we in solvent right now? Yeah, sorry, you should start living her job. I have several startups that had funds there. So I was literally part of a ton of email traffic in an emergency kind of, not board meetings, but emergency meetings over the last few days. And the complexion or the viewpoint of VCs was different. There were VCs who were like, calm down. Everything's gonna be fine. They've been around forever. We wanna be supportive of them. And there's no way the government's gonna let them go down. To someone else saying they were spending all their time in a war room with their portfolio companies telling them this is the last helicopter off the embassy in Hanoi. And so I'm not sure they had an obligation to stick with Silicon Valley bank, but to be clear, that's what caused the run. And so I don't know the morals or the ethics of it, but the only distinction I would make is that the younger VCs seem to be saying get out and the older VCs seem to be less, I don't know, less scared or I don't know if they were even friends, but I didn't think they, they didn't seem as panicked. And maybe they should have been depending on what happens or what plays out here. But there was definitely two different approaches, if you will, there was sort of like Peter Thiel on Twitter saying, get out, it's collapsing. And you could argue, was he right? Or did he play a role in the collapse? And Peter Thiel is a bit of a libertarian and has homes in New Zealand and bunkers. And, you know, wants to build an island because I generally think he's a catastrophist and a nihilist. So, but you saw a range of reactions here, but yeah, they caused the run on the bank, but that's their, their job is just to look after their LPs, not to say Silicon Valley bank. I'll ask more about ProfG Media's finances later, but you mentioned, you mentioned that the government will bail them out, that the government couldn't let this happen.
What are your thoughts on government's role here? So right now, according to the statement and the kind of the word is that one, everybody gets access to a quarter of a million dollars because it's FDIC insured kind of open a business on Monday. They'll then get an additional dividend based on the government's assessment or the whoever, whatever division of the government actually sees the bank based on what they think they can immediately get in terms of deposits as a ratio or a percentage of total deposits that they'll send out another 50 or 60% or give you what's called a dividend, they're referring to a dividend, and then you'll have to get in line and the administrator or court administrator based on what happens will give you the rest based on what they recover. That's sort of a traditional, almost like a traditional bankruptcy, if you will. That's what's going to happen to the shareholders or to the depositors at FTX. I don't think that's what's going to happen here. I think what is going to happen, And I'm conflicted, but I'm not worried, if you will. I don't, none of our companies are going out of business if that's the scenario. I think that's sort of the worst case scenario. And that's fine. Some of the companies I'm involved in would absolutely register a destruction in capital, but it wouldn't put any of them out of business. None of them would have trouble making their payroll as far as I know. But I think, I don't think that's how it plays out. And I do think one way or the other, the depositors are made whole and that is communicated fairly early this week. And it's for the following reasons. I'm not sure it qualifies as a plain vanilla bailout. Now, why is that? A bailout is when you come in and bail out the company and its shareholders and its management. So when the government came in and bailed out airlines during COVID, they were basically bailing out management who had used all of their free cash load for a share repurchases and management ended up making a lot of money. And the shareholders and management were sort of bailed out, if you will. That's already done here. The equity is wiped out. The management is wiped out. Their options are all worthless. The company is out of business. Who you would be quote unquote bailing out is you would just be making the depositors whole. So the analogy would be if you had let Delta go out of business and then if passengers at the airline, if the government came in and said, we see a systemic risk if we don't give the passengers back the money they spent on tickets in the future. Now, that goes to what the systemic risk here is or what the problem is. And the reason why I think ultimately the Biden administration and the regulators will decide to make depositors whole. And that is if you do the math here and you really start game theorying it out and the depositors get 70, 80, 95 cents on the dollar and they don't have access to that capital for a while, why wouldn't every VC demand as part of their investment in any company that they only bank with a company that has at least $2 trillion under assets? I think this basically if they don't back the deposits, effectively what you have is that every regional or niche or specialty bank in America begins a slow march to death. Because this was a black swan event. This was unusual, this wasn't fraud. And by the way, being unlucky is something you should pay for and management and shareholders are paying for that. But if you decide that the black swan event can take out the depositors, not only the shareholders and management's stake, but depositors, then what depositor, what small company, why would Prof. G, why would anyone, why would Vox who also had money there, Roku, why wouldn't anyone just say, okay, there's now three or four banks that we'll all do business with and no one else? Because if it can happen to these guys at 200 billion, it can happen to First National, it can happen to all the other banks that aren't JP Morgan, B of A, City, Wells, and Gold. I mean, basically there's like five. And then what happens? When you have a concentration like that or a flight to strength or a flight to the biggest players, those players love it. But then ultimately they begin raising the fees, they start practicing their oligopoly power, abusing their oligopoly leverage. You have a less robust banking system because now you have a concentration of banks that are so important that they literally are too big to fail and most of them are already. And I think that the risk, the systemic risk goes up and fees on the end customer go up over the medium and longterm. In addition, just politically, the unintended consequences here are just gonna be terrible headlines. I mean, Senators Warren and Cruz are already giving Chairman Powell a really hard time for raising interest rates this fast. What happens when a hospital's staffing software shuts off because that little company couldn't make their payroll or because the credit card that was on auto-renew for utilities at another company automatic, that was a credit card from SVP gets shut off. When you start hearing drip after drip of all these once promising companies that now have to lay off people because they don't have access to this cash, I think this is nothing but a series of really, really bad headlines for the Biden administration if they don't in fact come in and just say, look, we're assuring depositors. Now, people say, well, what about moral hazard? You know, what's next? You do this to everybody. The moral hazard here is I don't think really in play because the people who made these decisions have sent a strong signal to other people, don't make the same decision because we've lost everything. The equity's wiped out, management's lost all of their, whatever stock they had in this company, whatever wealth they had thought they'd accrued through pensions. So I don't know if this encourages more risky behavior. You could argue, well, that means people won't be as careful about their cash management. That might be true, but I think people see what's gone on here. So it strikes me as one of those few times where not a bailout, but backing the depositors might make sense now. And I realize I'm rambling on. What I think happens, what I think happens is that as a species and as a society and as media, we're much better catastrophizing and seeing the downside than the upside. I think what was really fortunate here is that it happened on a Thursday and a Friday. I think as the market digests this over the weekend, somebody's greed glands are gonna get going. And what do I mean by that? Somebody's gonna realize that there are few brands in business that have a better relationship with and dominance with a more profitable sector than SBB does in tech. They kind of own an incredibly lucrative sector as it relates to banking. And it's not only banking, it's wealth management, it's venture debt, it's mortgages. I mean, it's been a great business and it has a great reputation. One in two VC-backed startups bank with SBB. I've been banking with SBB for decades. I would imagine the firms I've started or work with have generated tens of millions of fees for SBB. And I would continue doing business with SBB. Somebody, Goldman, Marcus is looking for a reason for being, a raison d'etre, they're looking for a purpose. What if David Solomon gets on the phone with Chairman Powell or Secretary Yellen or whoever's managing this shit show and says, all right, government buys the bonds, those three-year long dated bonds, you're gonna take a little bit of a haircut but not much because you can borrow money really inexpensively. And I'll take all of this business and overnight, I go from zero to 60 as the premier tech consumer banking company. All of a sudden Marcus overnight is the tech bank that they can essentially establish in days for almost no money down. What has taken Silicon Valley Bank decades? So I would bet, I would speculate a Jamie Dimon, a David Solomon after having digested what's gone on here and after a few calls to key people in the administration who will say, we'll make sure your downside exposure isn't that great here, are gonna step in and say, we now own SBB, the deposits are guaranteed and take advantage of this dislocation and depositors are, I don't wanna even say made whole but are guaranteed and we're gonna see this as one of the most elegant sort of acquisitions or distressed acquisitions in history, that's my bet.
We're back with Prof G Markets. I wanna get your thoughts on this controversy that's going on with David Sacks right now. I don't know if you've seen this on Twitter. So basically a tweet, someone screenshotted one of David Sacks' tweets from last year and he said, quote, the idea that the American government, the American taxpayer or any American company is obligated to provide support is pure entitlement. And then just I think today or yesterday he tweeted, quote, where is Powell, where is Yellen, stop the crisis now, announce that all depositors will be safe, place SVP with a top four bank, do this before Monday open or there will be contagion and the crisis will spread. And obviously the thing that people are calling him out on is the hypocrisy there that he's saying, no government, we don't need this, that's ridiculous, that the government steps in and then now he's saying, all hell is broken loose, where is the government? To be fair to him, the previous tweet was referring to the Ukraine situation. It wasn't about bank bailouts, but it still feels important here that this is a guy who is an extreme libertarian, who basically decries regulators constantly. And my personal feeling about this is that it feels like when times are good, everyone says we don't need regulation, regulators should step out of the way. And then when times are bad, like right now, suddenly everyone's freaking out and saying, where are the regulators, they're supposed to do that job? 
Well, everyone's a capitalist when it isn't their money. And then, so one of the tweets I put out that got a ton of, I don't know, heat or action was, I said, capitalism on the way up and socialism on the way down is neither, it's cronyism. And I think people are gonna likely expect that I would say, no, just let the chips fall. And my sense is, yeah, you let the equity get wiped out. You let the people who made these decisions, whether it was a bad decision or just unlucky, you let them get wiped out. You let the equity holders get wiped out. But the question is, would it be pretty easy to line up an acquirer who benefits from this wildly and just ensure that we don't start this steady march to consolidation of the banking industry? It ultimately ends up hurting the economy, ends up hurting startups who have to pay higher fees because we end up with four or five banks. I mean, we end up with a banking system. The reason why, the definition of robust is the fast food industry. If McDonald's goes out of business, you're still gonna be able to get a burger. The financial services industry always runs the risk of not being robust, of being fragile. And that is if JP Morgan goes down, we might have a global crisis. That is not a robust industry. Part of what makes a robust industry is that you have a lot of different players and you have competition. And so, I think there's an argument to be made here that if they can't figure out an elegant way to put this in the hands of someone else, and maybe the government comes in and backstops those long-term government bonds, you already had people who got hurt very badly. So I think you avoid the moral hazard. You stop the slow walk to concentration in the industry, not the run on the bank, but a slow walk to concentration in the industry that'll take place. Because I'm just thinking, if we're a prof G, and I don't wanna go through this bullshit again, don't we just all put our money with JP Morgan? I mean, do we ever go to like a smaller bank? Do we ever go to... SBB had 200 billion under assets, JP Morgan has 3.3 trillion. There's, I think, a few that have more than 2 trillion. And then everyone else effectively just becomes a distressed bank that is slowly going out of business. I don't think they want that. So I think people should get hurt, whether it's bad decisions or they're unlucky. The equity holders have been wiped out here, but I think it probably makes sense. And what I think is going to happen is that people from the Biden administration get on the phone with the heads of one of these big banks and say, do you wanna be the leading tech consumer bank in the world kind of overnight? And it's not gonna cost the government a whole lot and you'll need to come up. They'll create a small bidding war over the weekend. I bet it's going on right now. But you're talking about an opportunity to come in and sort of own a sector overnight. So I think this gets done. I think the company gets acquired, absorbed. And I think 70, 80, 90% of their clients will go to the new player. People were happy with the bank. They don't feel like they were dealing with bad actors that they were misled and that there was fraud involved. As a matter of fact, a bunch of really tier one VCs just issued a joint statement saying, whoever takes this thing, if someone takes it, we're keeping our business with SVP. So if it's SVP, a Goldman Sachs company, or Marcus, an SVP company, and then it just becomes Marcus, this company is off to the races. So I think we're going from fear to greed over the weekend. And I think with some little or no government backstopping of those bonds, this thing gets handed off to someone else. And the depositors are made whole overnight. And somebody ends up with a free gift with purchase.
Someone overnight becomes the leading consumer tech banker. Do you think regulators should have had a larger role leading up to this? And the reason I say that is the regulations on these big banks that you're talking about are tremendous. And that is a result of everything that happened in 2008 and the Dodd-Frank reforms, and they set all of these rules and regulations for these big banks. But it's actually different for Silicon Valley Bank, which is smaller. Do you think that we should have had more regulation on these smaller, more regional banks leading up to this? 
What you're talking about effectively is a stress test. And the stress tests have gone way up. The stress tests basically now imagine three different types of recession, happening at the same time in a perfect storm. And as a result, the resilience, the enduring nature of banks is much greater. And there's been very few people that believe the banking system is coming down, that this is the first domino. This was a highly unusual event inspired by mismatched durations, massive acceleration interest rates, and even more than that, 30 or 50 people that could cause a run on the bank because they controlled or influenced a thousand companies. There isn't one person in the entertainment industry or in the mining industry that can call 50 companies and say, pull all your money now. So what there might be more regulation around is my understanding is those bonds, those T-bills they had, that they weren't marked real time, that they let them sit on their balance sheet at their maturity value. Because if they were held to maturity, they'd get par, they'd get a hundred cents on the dollar back. They probably should have had to mark them at whatever it was, 90 or I don't know what the true mark was based on the fact that if they had to sell them, they were going to have to sell them at a severe discount to match the price that bonds with that yield were getting in the open market at that point. That is where I think people will zero in on what was the oversight in regulation. But these banks, but the banking system is much more the quality of the loans they have. I mean, try and get a mortgage. It's much harder now, the coverage they have. Now the problem is everyone was running over to First National. If people think that, okay, this can happen at First National now with the same concentration, the same type of industry, does the whole concept of a niche, of banks serving a niche sector, does it just become unviable and it goes away? And is that good for the, is that good for the ecosystem? That's what it comes, that's what it comes down to.
So let's end with this. You, we are banked with Silicon Valley bank. You have a lot of startups that are as well. Are you worried going into this week?
I'm not. Well, first off, ProfG, we're profitable. So we make payroll by virtue of our cash flow. That's a good point. So it's a bummer if we don't get a hundred cents on the dollar backed, but it's not, it's meaningful, but it's not profound for us. Our other companies are the other companies I'm involved in, they have deep pocketed VCs who believe that we're going to get the majority of this back. So if there's a problem making payroll, it's going to be an administrative headache, but they're going to be, I think they're going to be fine. I don't, I just can't see that we're going to let the momentum of these companies or the the value of them erode substantially or let a vulture come in and finance these things and dilute us. I just don't, I don't see that happening. Philosophically, what I would say to young entrepreneurs and people who got caught here is that, and this is true of everything. And it's something I've held on to for the last 20 years of my life that gives me a lot of comfort. Nothing is ever as good or as bad as it seems. And maybe you raised a hundred million dollars at a billion dollar valuation 15 months ago, and you thought you were worth a hundred million dollars. No, you weren't and you aren't. Things aren't as good as they seemed. At the same time, thinking that your business is out of business and you're not gonna be able to make payroll, I'm fairly certain telling you that things aren't as bad as they seem. That this too shall pass.
I think this gets solved. Okay, thanks Scott. And thanks to our listeners for listening. Tune in on Monday for our regularly scheduled Prof G Markets episode
"""

# Split into a list of sentences
texts = text.split('.')

# Clean up to remove empty spaces and new lines
texts = [t.strip(' \n') for t in texts]




# Embedding Model for converting text to numerical representations
embedding_model = HuggingFaceEmbeddings(
    model_name='thenlper/gte-small'
)


from langchain_community.vectorstores import FAISS

# Create a local vector database
db = FAISS.from_texts(texts, embedding_model)

#from langchain import PromptTemplate
import langchain_core
from langchain_core import prompts
from langchain_core.prompts import PromptTemplate
from langchain.chains import RetrievalQA


# Create a prompt template
template = """<|user|>
Relevant information:
{context}

Provide a concise answer the following question using the relevant information provided above:
{question}<|end|>
<|assistant|>"""
prompt = PromptTemplate(
    template=template,
    input_variables=["context", "question"]
)


from langchain_core.prompts import PromptTemplate

template = """Question: {question}

Answer: So, """
prompt = PromptTemplate.from_template(template)

chain = prompt | hf

question = "What happened to Silicon valley bank?"

print(chain.invoke({"question": question}))

